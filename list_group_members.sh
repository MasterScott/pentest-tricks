#!/bin/bash
# Will recursively list members of given domain groups

DOMAIN_CREDS='DOMAIN\jsmith%Password1'
DOMAINS=('DOMAIN 10.0.0.100')
FALLBACKDC='10.0.0.100'

if (( $# < 1)); then
  echo "usage: $0 'DOMAIN\\Domain Admins' '.\\Administrators'"
fi

net_members()
{
  local dc
  for i in "${DOMAINS[@]}"; do
    domain=$(echo $i | cut -d ' ' -f1)
    ip=$(echo $i | cut -d ' ' -f2)
    if [[ $1 == $domain ]]; then
      dc=$ip
      break
    fi
  done
  if [[ -z $dc ]]; then
    dc=$FALLBACKDC
  fi

  net -l -U "$DOMAIN_CREDS" -S "$dc" rpc group members "$2"
}

print_members()
{
echo "$indent$1"

local indent="$2  "
local d=$(echo "$1" | cut -d '\' -f1)
local n=$(echo "$1" | cut -d '\' -f2-)


while read -r line; do

  sid=$(echo "$line" | cut -d ' ' -f1)
  domain=$(echo "$line" | cut -d ' ' -f2- | cut -d '\' -f1)
  temp=$(echo "$line" | cut -d ' ' -f2- | cut -d '\' -f2-)
  name=$(echo "$temp" | sed -ne 's,^\(.*\) [0-9]$,\1,p')
  use=$(echo "$temp" | sed -e 's,^.* ,,')

  #echo "$name ($domain)"
  
  if [[ $use == "1" ]]; then
    echo "$indent$name"
  else
    #echo "$indent$line"
    print_members "$domain\\$name" "$indent"
  fi 

done < <(net_members "$d" "$n")

}

for grp in "$@"; do
  print_members "$grp"
  echo
done
