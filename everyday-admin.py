#!/usr/bin/env python

# Copyright (C) 2015 Sebastien MACKE
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 2, as published by the
# Free Software Foundation
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
# details (http://www.gnu.org/licenses/gpl.txt).

from sys import argv
from os.path import basename
from collections import defaultdict

def usage():
  print '''Usage: %s <domain.pwdump> <admins.pwdump> [hashcat.pot john.pot ...]'
Example:
$ python everyday-admin.py domain.pw admins.pw hashcat.pot ~/.john/john.pot
* Sharing f4dcffd5f469f9ed4474a1fa98b6fe8d (Bonjour!23)
fr.xyz.internal\\amichel-adm (admin)
fr.xyz.internal\\amichel

* Sharing 3512cd8f085641a814b4424f088071f0 (Sacrebl3u)
fr.xyz.internal\\pmartin-adm (admin)
fr.xyz.internal\\pmartin

* Sharing 8d85d77e0acc7257b5f60b46ed4a1cc4 (n/a)
uk.xyz.internal\\jsmith-adm (admin)
uk.xyz.internal\\jsmith
...''' % basename(argv[0])
  exit(2)

if len(argv) < 3:
  usage()

domain_file = argv[1]
admins_file = argv[2]
pot_files = argv[3:]

def load_users(filepath):
  users = defaultdict(list)

  for line in open(filepath):

    username, _, _, nt, _ = line.split(':', 4)
    username, nt = username.lower(), nt.lower()

    if '\\' in username:
      domain, username = username.split('\\', 1)
    else:
      domain = ''

    users[username].append((domain, nt))

  return users

def lookup_plain(nt_hash):
  for f in pot_files:
    for line in open(f):
      line = line.rstrip()
      if nt_hash in line:
        pw = line.split('%s:' % nt_hash, 1)[-1]
        return pw

domain = load_users(domain_file) # domain.pw
admins = load_users(admins_file) # admins.pw

share_nt = defaultdict(list)
for user_name, user_info in domain.iteritems():

  if user_name in admins:
    continue

  for user_domain, user_nt in user_info:
    if user_nt == '31d6cfe0d16ae931b73c59d7e0c089c0': # blank password
      continue

    for admin_name, admin_info in admins.iteritems():
      for admin_domain, admin_nt in admin_info:
        if user_nt == admin_nt:
          share_nt[admin_nt].append(('%s\\%s' % (user_domain, user_name) if user_domain else user_name, '%s\\%s' % (admin_domain, admin_name) if admin_domain else admin_name))


for nt_hash, sharers in sorted(share_nt.iteritems()):

  print '* Sharing %s (%s)' % (nt_hash, lookup_plain(nt_hash) or 'n/a')
  print '\n'.join(set('%s (admin)' % admin for _, admin in sharers))
  print '\n'.join(set(user for user, _ in sharers))
  print

